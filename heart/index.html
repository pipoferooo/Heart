<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hälsning till min chorris i Torrevieja ❤️</title>

  <!-- PUNKT 2: PWA-head (manifest + färg + iOS-stöd) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ffc2d1" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root{
      --bg1:#fff0f6; /* ljus rosa */
      --bg2:#ffd6e7; /* rosa */
      --bg3:#ffeaf5; /* rosa dim */
      --card:#ffffff;
      --ink:#222;
      --accent-2:#faad14; /* sol */
      --btn-red:#ff6b81;      /* röd */
      --btn-pink:#ffc2d1;     /* pastellrosa */
      --btn-pink-text:#6b233b;/* mörk text på rosa */
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background: radial-gradient(1200px 700px at 20% 0%, var(--bg3), transparent 60%),
                  radial-gradient(900px 600px at 80% 100%, var(--bg2), transparent 60%),
                  radial-gradient(1000px 900px at 50% 50%, var(--bg1), var(--bg1));
      display:grid; place-items:center; padding:20px;
    }

    .frame{ width:min(880px, 92vw); background:var(--card); border-radius:24px; box-shadow: 0 10px 30px rgba(0,0,0,.12); overflow:hidden; }

    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px 20px; background:linear-gradient(90deg, #ffecd1, #ffe5f1 60%, #e8f6ff); border-bottom:1px solid rgba(0,0,0,.06); }
    header h1{font-size:20px; margin:0; display:flex; align-items:center; gap:10px;}
    .clock{font-size:14px; opacity:.8}

    .content{ display:grid; grid-template-columns:1.1fr .9fr; }
    @media (max-width:840px){ .content{grid-template-columns:1fr} }

    /* Vänster */
    .postcard{ position:relative; padding:28px; min-height:360px; background:
      radial-gradient(circle at 90% 10%, rgba(255,255,255,.7), transparent 35%),
      linear-gradient(135deg, rgba(255,255,255,.65), rgba(255,255,255,.25)),
      linear-gradient(0deg, #ffd6e7, #ffe7f1 40%, #ffd6e7);
      display:flex; flex-direction:column; gap:16px; }
    .salutation{font-size:28px; margin:0; font-weight:700;}
    .note{font-size:18px; line-height:1.5; margin:0; max-width:56ch; background: rgba(255,255,255,.6); padding:12px 14px; border-radius:14px; backdrop-filter: blur(4px);}    

    /* Höger */
    .secret-wrap{ position:relative; min-height:360px; background: #fff; }
    .secret{ position:absolute; inset:0; padding:28px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; gap:14px; background: linear-gradient(180deg, #fff 0%, #fff5f7 100%); z-index:1; }

    /* Brevpapper-stil */
    .letter{ position:relative; width:min(520px,88%); background: repeating-linear-gradient(180deg, #fff, #fff 28px, #ffe6f1 29px, #ffe6f1 30px); border:1px solid rgba(0,0,0,.08); border-radius:18px; box-shadow: 0 8px 20px rgba(0,0,0,.08); padding:22px 20px; }
    .letter p{ margin:0; font-size:20px; line-height:1.6; }
    .letter:after{ content:''; position:absolute; top:10px; left:50%; transform:translateX(-50%); width:58px; height:10px; background:rgba(0,0,0,.06); filter:blur(6px); border-radius:10px; opacity:.6; }

    canvas#scratch{ position:absolute; inset:0; width:100%; height:100%; cursor:grab; touch-action:none; z-index:2; }

    .controls{display:flex; gap:8px; align-items:center; margin:10px 0 0; flex-wrap:wrap; position:relative; z-index:3; }
    button{ appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:600; background:var(--btn-red); color:#fff; cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.18); transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
    button.secondary{ background:var(--btn-pink); color:var(--btn-pink-text); box-shadow: 0 6px 16px rgba(255, 176, 196, .55); }
    #newmsg:hover{ filter:brightness(1.05); transform:translateY(-1px); box-shadow:0 8px 18px rgba(255,107,129,.35); }
    #reveal:hover{ filter:brightness(1.03); transform:translateY(-1px); box-shadow:0 8px 18px rgba(255,194,209,.45); }

    /* Konfetti */
    .fx{ pointer-events:none; position:absolute; inset:0; overflow:hidden; z-index:4; }
    .fx .p{ position:absolute; bottom:-4px; font-size:20px; animation: floatUp 6.2s ease-in forwards; color:#ff6b81; }
    @keyframes floatUp { 0%{ transform: translateY(0) translateX(0) rotate(0deg); opacity:1 } 85%{ opacity:.98 } 96%{ opacity:.95 } 100%{ transform: translateY(-420%) translateX(var(--dx)) rotate(20deg); opacity:0 } }

    footer{ padding:12px 20px; font-size:13px; display:flex; justify-content:space-between; gap:8px; align-items:center; color:#555; background:#fff; border-top:1px solid rgba(0,0,0,.06); }
    .tiny{opacity:.75}

    @media (max-width: 600px){ body{ padding:12px; } header{ padding:12px 14px; } .postcard{ min-height:210px; padding:16px; } .secret-wrap{ min-height:240px; } .note{ font-size:16px; } .letter{ width:92%; } }
  </style>
</head>
<body>
  <div class="frame" role="main" aria-label="Skrapkort med minibrev till älskling i Torrevieja">
    <header>
      <h1><span class="flag">🇪🇸</span> Hälsning till min Chorris i Torrevieja ❤️</h1>
      <div class="clock" id="clocks" aria-live="polite">Laddar tider…</div>
    </header>

    <div class="content">
      <!-- Vänster -->
      <section class="postcard">
        <p class="salutation">Hej älskling! 🥰</p>
        <p class="note">Skrapa rutan för en hälsning. Tryck på Ny hälsning och skrapa igen.</p>
      </section>

      <!-- Höger: Hemligt område -->
      <section class="secret-wrap">
        <div class="secret" id="secret" aria-hidden="true">
          <div class="letter"><p id="msg" aria-live="polite">(skrapa för att se)</p></div>
          <div class="controls">
            <button id="newmsg">Ny hälsning</button>
            <button id="reveal" class="secondary">Konfetti</button>
          </div>
        </div>
        <canvas id="scratch" aria-label="Skrapyta för att avslöja meddelandet"></canvas>
        <div class="fx" id="fx"></div>
      </section>
    </div>

    <footer>
      <span class="tiny">Single-file · Ingen server · Mobilvänlig</span>
    </footer>
  </div>

<script>
(function(){
  // ============
  // KONSTANTER & DATA
  // ============
  const EMOJI = {
    HEARTS: ['❤️','💖','💗','💕','💞','💘','💝','💓'],
    LOVE_SMILES: ['😘','😍','🥰','😚','😙'],
    VACAY: ['☀️','🌞','🌅','🌊','🏖️','🌴','🕶️','🍹','🍸','🍷','🥂','🍍','🍉','🍓','🍦']
  };

  const THEMES = {
    sunbeach: ['☀️','🌊','🏖️','🌴','🕶️','🌞','🍦'],
    heartsmiles: ['🥰','😍','😘','😙','😚','💖','💞','❤️'],
    drinks: ['🍹','🍸','🥂','🍾','🍍','🍓'],
    roses: ['🌹','🌺','🌷','💐','🌸','💮','💘'],
    glitter: ['✨','⭐','🌟','💫','💖']
  };

  const MORNING = [
    "God morgon älskling. Hoppas du får en fin dag!",
    "God morgon älsking, Saknar dig!",
    "God morgon finis, glöm inte vatten och solkräm.",
    "God morgon! Ät en god frukost!"
  ];
  const GOODNIGHT = [
    "Sov gott puss och kram.",
    "Godnatt älskar dig",
    "Sov gott saknar dig"
  ];
  const GENERAL = [
    "Tänker på dig",
    "Hejar på dig här hemifrån",
    "Hoppas du får en fin dag!",
    "Skicka en bild när du hinner",
    "Ät god mat!",
    "Kom ihåg att dricka vatten",
    "Lycka till idag",
    "Ta en paus och andas",
    "Köp något som gör dig glad!",
    "Var inte snål mot dig själv!",
    "Köp något kul!",
    "Puss och kram"
  ];

  // ============
  // KLOCKOR
  // ============
  const clocksEl = document.getElementById('clocks');
  function fmt(tz){ return new Intl.DateTimeFormat('sv-SE', { hour:'2-digit', minute:'2-digit', timeZone: tz }).format(new Date()); }
  function tick(){ clocksEl.textContent = `Stockholm ${fmt('Europe/Stockholm')} • Torrevieja ${fmt('Europe/Madrid')}`; }
  tick(); setInterval(tick, 1000);

  // ============
  // ELEMENT
  // ============
  const canvas = document.getElementById('scratch');
  const fx = document.getElementById('fx');
  const msgEl = document.getElementById('msg');
  const btnReveal = document.getElementById('reveal');
  const btnNew = document.getElementById('newmsg');

  let ctx, pxRatio = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let isDown = false;
  let revealed = false;
  let brush = 30; // default, uppdateras i setBrushSize()
  const CONFETTI_MODE = 'random';
  let lastMsg = '';

  function setBrushSize(){
    brush = window.matchMedia('(max-width: 600px)').matches ? 34 : 30; // lite större
  }
  setBrushSize();
  window.addEventListener('resize', setBrushSize);

  function decorateMessage(msg, cat){
    const minCount = 3;
    const extra = Math.random() < 0.4 ? 1 : 0;
    const count = minCount + extra;

    const pool = (cat === 'general')
      ? EMOJI.VACAY.concat(EMOJI.HEARTS)
      : EMOJI.HEARTS.concat(EMOJI.LOVE_SMILES);

    const out = [];
    // minst ett hjärta
    out.push(EMOJI.HEARTS[Math.floor(Math.random()*EMOJI.HEARTS.length)]);
    while(out.length < count){ out.push(pool[Math.floor(Math.random()*pool.length)]); }
    // shuffle
    for(let i=out.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [out[i],out[j]]=[out[j],out[i]]; }
    return msg + ' ' + out.join(' ');
  }

  function hourInMadrid(){ const s = new Intl.DateTimeFormat('sv-SE',{hour:'2-digit', hour12:false, timeZone:'Europe/Madrid'}).format(new Date()); return parseInt(s,10); }
  function categoryForHour(h){ if(h >= 6 && h <= 10) return 'morning'; if(h >= 23 || h <= 2) return 'goodnight'; return 'general'; }
  function categoryForNow(){ return categoryForHour(hourInMadrid()); }
  function poolFor(cat){ if(cat==='morning') return MORNING; if(cat==='goodnight') return GOODNIGHT; return GENERAL; }

  function pickMessage(){
    const cat = categoryForNow();
    const pool = poolFor(cat);
    if(pool.length===0){ msgEl.textContent = ''; return; }
    let i = Math.floor(Math.random()*pool.length);
    // undvik upprepning
    let guard=0; while(pool[i]===lastMsg && guard<8){ i = Math.floor(Math.random()*pool.length); guard++; }
    lastMsg = pool[i];
    msgEl.textContent = decorateMessage(lastMsg, cat);
  }

  function sizeCanvas(){ const w = canvas.clientWidth; const h = canvas.clientHeight; canvas.width = Math.floor(w * pxRatio); canvas.height = Math.floor(h * pxRatio); ctx = canvas.getContext('2d'); ctx.scale(pxRatio, pxRatio); }

  function paintOverlay(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const g = ctx.createLinearGradient(0,0,w,h);
    g.addColorStop(0, '#c8f7dc');
    g.addColorStop(1, '#a6e9c8');
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
    ctx.globalAlpha = 0.18; ctx.fillStyle = '#2e8b57';
    const stripe = 10;
    for(let x=-h; x < w+ h; x+= stripe*2){ ctx.save(); ctx.translate(x,0); ctx.rotate(Math.PI/4); ctx.fillRect(0,0,stripe,h*2); ctx.restore(); }
    ctx.globalAlpha = 1;
    ctx.fillStyle = 'rgba(255,255,255,.85)';
    ctx.font = '700 22px ui-sans-serif, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Skrapa här ✨', w/2, h/2);
  }

  function reseed(){
    revealed = false;
    if(msgEl) msgEl.style.visibility = 'hidden';
    canvas.style.transition = 'none'; canvas.style.opacity = '1'; canvas.style.pointerEvents = 'auto';
    sizeCanvas(); paintOverlay();
    pickMessage(); fx.innerHTML = '';
    requestAnimationFrame(()=>{ canvas.style.transition = 'opacity .5s ease'; if(msgEl) msgEl.style.visibility = 'visible'; });
  }

  function scratchAt(x, y){ if(!ctx) return; ctx.save(); ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(x, y, brush, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }

  function getClearedRatio(sampleStep=8){ try{ const w = Math.floor(canvas.clientWidth * pxRatio); const h = Math.floor(canvas.clientHeight * pxRatio); const data = ctx.getImageData(0,0,w,h).data; let cleared=0, total=0; for(let i=3; i<data.length; i += 4*sampleStep){ total++; if(data[i] === 0) cleared++; } return cleared/total; }catch(e){ return 0; } }
  function maybeReveal(){ if(revealed) return; const ratio = getClearedRatio(); if(ratio > 0.8){ revealAll(); } }

  // -------- Konfetti helpers --------
  function burstFromSymbols(arr, opts={}){
    const count = opts.count || 28;
    const extraDelay = opts.extraDelay || 0;
    for(let i=0;i<count;i++){
      const el = document.createElement('div');
      el.className = 'p';
      el.textContent = arr[Math.floor(Math.random()*arr.length)];
      el.style.left = Math.random()*95 + '%';
      el.style.setProperty('--dx', (Math.random()*80 - 40) + 'px');
      const baseDelay = (Math.random()*0.5);
      el.style.animationDelay = (baseDelay + extraDelay/1000) + 's';
      el.style.fontSize = (18 + Math.random()*22) + 'px';
      fx.appendChild(el);
      setTimeout(()=> el.remove(), 7600);
    }
  }
  function burstRandomTheme(){ const keys = Object.keys(THEMES); const key = keys[Math.floor(Math.random()*keys.length)]; burstFromSymbols(THEMES[key], {count: 28}); }
  function burstConfetti(){ burstFromSymbols(['❤️','💖','💗','💓','💕','💞','💘','💝'], {count: 28}); }

  function revealAll(){ revealed = true; canvas.style.transition = 'opacity .5s ease'; canvas.style.opacity = '0'; canvas.style.pointerEvents = 'none'; burstConfetti(); }

  function posFromEvent(ev){ const r = canvas.getBoundingClientRect(); if(ev.touches && ev.touches[0]){ return { x: ev.touches[0].clientX - r.left, y: ev.touches[0].clientY - r.top }; } return { x: ev.clientX - r.left, y: ev.clientY - r.top }; }
  canvas.addEventListener('pointerdown', e=>{ isDown=true; canvas.setPointerCapture(e.pointerId); canvas.style.cursor='grabbing'; const p = posFromEvent(e); scratchAt(p.x, p.y); maybeReveal(); });
  canvas.addEventListener('pointermove', e=>{ if(!isDown) return; const p = posFromEvent(e); scratchAt(p.x, p.y); maybeReveal(); });
  canvas.addEventListener('pointerup',   e=>{ isDown=false; canvas.style.cursor='grab'; });
  canvas.addEventListener('pointerleave',e=>{ isDown=false; canvas.style.cursor='grab'; });
  canvas.addEventListener('touchmove', e=>{ e.preventDefault(); }, {passive:false});

  // knappar
  btnReveal.addEventListener('click', ()=> burstRandomTheme());
  btnNew.addEventListener('click', ()=> reseed());

  // =====================
  // Små självtester (console)
  // =====================
  function countKnownEmojis(str){
    const ALL = EMOJI.HEARTS.concat(EMOJI.LOVE_SMILES, EMOJI.VACAY);
    let total = 0; for(const e of ALL){ let idx=str.indexOf(e); while(idx!==-1){ total++; idx = str.indexOf(e, idx + e.length); } } return total;
  }

  function runTests(){
    try{
      console.group('MiniBrevlåda – tester');
      console.assert(countKnownEmojis(decorateMessage('hej','general'))>=3, 'General ska ge minst 3 emojis');
      const dm = decorateMessage('hej','general');
      console.assert(EMOJI.HEARTS.some(h=> dm.includes(h)), 'General ska alltid innehålla minst ett hjärta');
      console.assert(categoryForHour(6)==='morning','06 ska vara morning');
      console.assert(categoryForHour(10)==='morning','10 ska vara morning');
      console.assert(categoryForHour(11)==='general','11 ska vara general');
      console.assert(categoryForHour(22)==='general','22 ska vara general');
      console.assert(categoryForHour(23)==='goodnight','23 ska vara goodnight');
      reseed();
      const r = getClearedRatio();
      console.assert(typeof r==='number' && r>=0 && r<=1, 'ratio ska vara siffra 0..1');
      console.assert(brush>=30, 'Pensel ska vara lite större (>=30)');
      // Nytt: pickMessage sätter text
      pickMessage();
      console.assert(msgEl.textContent && msgEl.textContent.length>0, 'pickMessage ska sätta text');
      // Nytt: burstRandomTheme lägger till partiklar
      const before = fx.children.length; burstRandomTheme(); const after = fx.children.length;
      console.assert(after>before, 'Konfetti-tema ska lägga till partiklar');
      console.groupEnd();
    }catch(e){ console.error('Tester fel:', e); }
  }

  const ro = new ResizeObserver(()=> reseed()); ro.observe(canvas);
  runTests();
})();
</script>

<!-- PUNKT 3: Registrera service worker före </body> -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
</script>
</body>
</html>
